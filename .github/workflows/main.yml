# =========================================================================
# CoreHive CI/CD Pipeline for Azure
#
# Author: She-han
# Created: 2025-11-19 20:59:45 UTC
#
# This workflow automates the build, test, and deployment of the CoreHive
# application.
#
# Branching Strategy:
# - Pushes/PRs to 'dev': Builds and pushes images to ACR (No deployment).
# - Pushes to 'main': Builds, pushes images, AND deploys to production.
# =========================================================================

# Workflow Name (as it appears in the GitHub Actions tab)
name: CoreHive CI/CD Pipeline to Azure

# -----------------
# 1. TRIGGER CONFIGURATION
# -----------------
# Defines when this workflow should be automatically executed.
on:
  # Trigger on pushes to the 'main' branches
  push:
    branches:
      - main
      

  # Also trigger when a Pull Request is opened or updated against 'main' branch
  pull_request:
    branches:
      - main
     

  # Allows manual triggering of the workflow from the GitHub Actions UI
   
  workflow_dispatch:

# -----------------
# 2. JOBS CONFIGURATION
# -----------------
# A workflow run is made up of one or more jobs.
jobs:
  # Define a single job named 'build-and-deploy'
  build-and-deploy:
    # The type of virtual machine to run the job on
    runs-on: ubuntu-latest
    
    # -----------------
    # 3. STEPS CONFIGURATION
    # -----------------
    # A sequence of tasks to be executed as part of the job.
    steps:
    # Step 1: Download the repository's source code into the runner machine
    - name: 'Step 1: Checkout repository code'
      uses: actions/checkout@v4

    # Step 2: Log in to Azure using the Service Principal credentials stored in secrets
    - name: 'Step 2: Log in to Azure'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # Step 3: Log in to Azure Container Registry (ACR) to push Docker images
    - name: 'Step 3: Log in to Azure Container Registry (ACR)'
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    # Step 4: Build and Push Backend Image
    - name: 'Step 4: Build and Push Backend Image'
      run: |
        docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/corehive-backend:${{ github.sha }} -f backend/Dockerfile ./backend
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/corehive-backend:${{ github.sha }}

    # Step 5: Build and Push Frontend Image
    - name: 'Step 5: Build and Push Frontend Image'
      run: |
        docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/corehive-frontend:${{ github.sha }} \
          --build-arg VITE_API_BASE_URL=https://corehive-backend-app-gtdreadhagd9ggfc.southeastasia-01.azurewebsites.net/api \
          --build-arg VITE_AI_SERVICE_URL=https://corehive-ai-service-app-fhh9hsebfhf6enbz.southeastasia-01.azurewebsites.net \
          --build-arg VITE_RECAPTCHA_SITE_KEY=${{ secrets.RECAPTCHA_SITE_KEY }} \
          -f frontend/Dockerfile ./frontend
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/corehive-frontend:${{ github.sha }}

    # Step 6: Build and Push AI Service Image (NEW)
    - name: 'Step 6: Build and Push AI Service Image'
      run: |
        docker build -t ${{ secrets.ACR_LOGIN_SERVER }}/corehive-ai-service:${{ github.sha }} -f ai-service/Dockerfile ./ai-service
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/corehive-ai-service:${{ github.sha }}

    # Step 7: Deploy Backend to App Service
    - name: 'Step 7: Deploy Backend to App Service'
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.BACKEND_APP_NAME }}
        images: '${{ secrets.ACR_LOGIN_SERVER }}/corehive-backend:${{ github.sha }}'

    # Step 8: Deploy Frontend to App Service
    - name: 'Step 8: Deploy Frontend to App Service'
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.FRONTEND_APP_NAME }}
        images: '${{ secrets.ACR_LOGIN_SERVER }}/corehive-frontend:${{ github.sha }}'

    # Step 9: Deploy AI Service to App Service (NEW)
    - name: 'Step 9: Deploy AI Service to App Service'
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AI_SERVICE_APP_NAME }}
        images: '${{ secrets.ACR_LOGIN_SERVER }}/corehive-ai-service:${{ github.sha }}'

    # Step 10: Logout from Azure and ACR
    - name: 'Step 10: Logout from Azure and ACR'
      if: always()
      run: |
        docker logout ${{ secrets.ACR_LOGIN_SERVER }}
        az logout